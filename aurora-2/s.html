<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smoke Particles</title>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  canvas { display:block; }
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
// -------------------- Setup --------------------
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

// -------------------- Perlin Noise --------------------
// Simple 2D Perlin noise approximation
function noise(x,y){
    return (Math.sin(x*12.9898 + y*78.233) * 43758.5453) % 1;
}
class PerlinNoise2D {
    constructor(seed=Math.random()*1000){
        this.seed = seed;
        this.permutation = [];
        for(let i=0;i<256;i++) this.permutation[i] = i;
        // Shuffle
        for(let i=255;i>0;i--){
            let j = Math.floor(Math.random()* (i+1));
            [this.permutation[i], this.permutation[j]] = [this.permutation[j], this.permutation[i]];
        }
        this.permutation = this.permutation.concat(this.permutation);
    }

    fade(t){ return t*t*t*(t*(t*6-15)+10); }
    lerp(t,a,b){ return a + t*(b-a); }
    grad(hash,x,y){
        let h = hash & 3;
        let u = h<2 ? x : y;
        let v = h<2 ? y : x;
        return ((h&1) === 0 ? u : -u) + ((h&2) === 0 ? v : -v);
    }

    noise(x,y){
        let X = Math.floor(x) & 255;
        let Y = Math.floor(y) & 255;
        let xf = x - Math.floor(x);
        let yf = y - Math.floor(y);
        let u = this.fade(xf);
        let v = this.fade(yf);

        let aa = this.permutation[this.permutation[X]+Y];
        let ab = this.permutation[this.permutation[X]+Y+1];
        let ba = this.permutation[this.permutation[X+1]+Y];
        let bb = this.permutation[this.permutation[X+1]+Y+1];

        let x1 = this.lerp(u, this.grad(aa, xf, yf), this.grad(ba, xf-1, yf));
        let x2 = this.lerp(u, this.grad(ab, xf, yf-1), this.grad(bb, xf-1, yf-1));
        return (this.lerp(v, x1, x2)+1)/2; // normalize to 0..1
    }
}

const perlin = new PerlinNoise2D();

// -------------------- Particles --------------------
class Particle {
    constructor(boid=false){
        this.reset();
        this.boid = boid;
    }
    reset(){
        this.x = W/2 + (Math.random()-0.5)*10;
        this.y = H - 10;
        this.vx = (Math.random()-0.5) * 0.025;
        this.vy = -0.5 - Math.random()*0.5;
        this.radius = 1 + Math.random()*2;
        this.alpha = 0.1 + Math.random()*0.2;
    }
    update(particles){
        // Basic upward motion
        this.y += this.vy;

        // Perlin-like horizontal sway
        let n = perlin.noise(this.x*0.01, this.y*0.01);
        this.x += (n - 0.5) * 1.5;

        // Boid-like behavior for half the particles
        if(this.boid){
            let neighbors = particles.filter(p=>p!==this && Math.abs(p.x-this.x)<50 && Math.abs(p.y-this.y)<50);
            if(neighbors.length>0){
                // Cohesion: move toward center of neighbors
                let cx = neighbors.reduce((a,b)=>a+b.x,0)/neighbors.length;
                let cy = neighbors.reduce((a,b)=>a+b.y,0)/neighbors.length;
                this.vx += (cx - this.x)*0.001;
                this.vy += (cy - this.y)*0.001;
                // Separation: avoid crowding
                neighbors.forEach(n=>{
                    let dx = n.x - this.x;
                    let dy = n.y - this.y;
                    let d2 = dx*dx + dy*dy;
                    if(d2<100) this.vx -= dx*0.001;
                });
            }
        }

        // Apply velocity
        this.x += this.vx;

        // Disperse and fade
        this.alpha *= 0.995;
        this.radius *= 1.0005;

        // Reset if invisible or off-screen
        if(this.alpha < 0.01 || this.y + this.radius < 0){
            this.reset();
        }
    }
    draw(){
        ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
        ctx.beginPath();
        ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
        ctx.fill();
    }
}

// -------------------- Initialize --------------------
const NUM_PARTICLES = 1200;
let particles = [];
for(let i=0;i<NUM_PARTICLES;i++){
    particles.push(new Particle(Math.random()<0.3)); // half boids
}

// -------------------- Animation Loop --------------------
function loop(){
    ctx.clearRect(0,0,W,H);

    particles.forEach(p=>{
        p.update(particles);
        p.draw();
    });

    requestAnimationFrame(loop);
}
loop();

// -------------------- Resize --------------------
window.addEventListener('resize', ()=>{
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
});
</script>
</body>
</html>
