<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Particle Test</title>
  <style>
    body { margin: 0; background: black; }
    canvas { display: block; }
  </style>
</head>
<body>
<canvas id="c"></canvas>
<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

function degToRad(deg) {
  return (deg * Math.PI) / 180;
}
function colorToStr(c) {
    return "hsla(" + Object.values(c).join(",") + ")";
}
function randomFrom(arr) {
    const index = Math.floor(Math.random() * arr.length);
    return arr[index];
}
function mt_rand(min = 0, max = 2147483647) {
    if (min > max) [min, max] = [max, min]; // swap if min > max
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
// one particle
class Particle {
    constructor(x, y, config) {
        this.originalX = x;
        this.originalY = y;
        this.lifetime = config.lifetime ?? mt_rand(200, 300); // frames
        this.spread = config.spread ? degToRad(config.spread) : degToRad(10);
        this.color = config.color ? {...config.color} : {h:0, s:"0%", l:"100%", a:1};
        this.setRandomColor(config);
        this.history = [];        // past positions
        this.maxTrail = config.maxTrail ?? 8;       // how many to keep
        this.gravity = config.gravity ?? 0.05;
        this.speed = config.speed ?? 3
        this.canReset = config.canReset ?? false;
        this.reset();
    }
    setRandomColor(config) {
        this.color = config.colors ? {...randomFrom(config.colors)} : this.color;
    }
    active() {
        return this.age <= this.lifetime || this.alpha > 0;
    }
    reset() {
        this.x = this.originalX;
        this.y = this.originalY;
        const baseAngle = -Math.PI / 2; // straight up
        //const spread = Math.PI / 1.3;     // cone - more number = tighter cone
        const angle = baseAngle + (Math.random() - 0.5) * this.spread;
        const speed = this.speed + Math.random() * this.speed;         // 2â€“5 px/frame
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed - 3;       // bias upward
        this.age = 0;  
        this.alpha = 1;
        this.history = [];
    }
    setReset(r) {
        this.canReset = r;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;

        this.history.push({ x: this.x, y: this.y });
        if (this.history.length > this.maxTrail) {
            this.history.shift(); // remove oldest
        }

        this.vy += this.gravity; // gravity per frame
        this.vx += Math.random() * 0.01; // wind 
        this.age++;
        this.alpha = 1 - this.age / this.lifetime;
        this.color.a = this.alpha;

        // reset when dead
        if (this.age > this.lifetime || this.alpha <= 0) {
            if ( this.canReset ) this.reset();
        }
        return this.active();
    }
    drawArc(ctx, x, y, sz, color) {
        ctx.fillStyle = colorToStr(color);
        ctx.beginPath();
        ctx.arc(x, y, sz, 0, Math.PI * 2);
        ctx.fill();
    }
    drawtrail(ctx) {
        ctx.beginPath();
        for (let i = 0; i < this.history.length; i++) {
            const p = this.history[i];
            this.color.a = (i / this.history.length) * this.alpha;
            this.drawArc(ctx, p.x, p.y, 2, this.color);
        }
    }
    draw(ctx) {
        this.drawtrail(ctx);
        this.drawArc(ctx, this.x, this.y, 2, this.color);
    }
}
class SprayFX {
    constructor(x, y, config) {
        this.isActive = true;
        this.particles = [];
        for ( let i = 0; i < config.count; i++ ) {
            this.particles.push(new Particle(x, y, config));
        }
    }
    getParticle(idx) {
        return this.particles[idx];
    }
    updateAndDraw(dt, ctx) {
        let allActive = true;
        for ( const p of this.particles ) {
            const active = p.update(dt);
            if (active) 
                p.draw(ctx);
            else 
                allActive = false;
        }
        this.isActive = allActive;
    }
    active() {
        return this.isActive;
    }
    inActive() {
        return ! this.isActive;
    }
}

/*const colors = ;*/
const colors = [
// Cyan / Teal
[
  { h:180, s:"100%", l:"55%", a:1 },
  { h:175, s:"100%", l:"50%", a:1 },
  { h:185, s:"95%",  l:"60%", a:1 },
  { h:190, s:"100%", l:"58%", a:1 },
  { h:170, s:"90%",  l:"52%", a:1 }
],

// Purple / Magenta
[
  { h:270, s:"100%", l:"55%", a:1 },
  { h:275, s:"100%", l:"50%", a:1 },
  { h:265, s:"95%",  l:"60%", a:1 },
  { h:280, s:"100%", l:"58%", a:1 },
  { h:260, s:"90%",  l:"52%", a:1 }
],

// Pink
[
  { h:330, s:"100%", l:"55%", a:1 },
  { h:340, s:"100%", l:"50%", a:1 },
  { h:320, s:"95%",  l:"60%", a:1 },
  { h:335, s:"100%", l:"58%", a:1 },
  { h:310, s:"90%",  l:"52%", a:1 }
],

// White / sparkle
[
  { h:0, s:"0%", l:"100%", a:1 },
  { h:0, s:"0%", l:"95%",  a:1 },
  { h:0, s:"0%", l:"90%",  a:1 },
  { h:0, s:"0%", l:"85%",  a:1 },
  { h:0, s:"0%", l:"80%",  a:1 }
],
[ // fiery
    { h:16, s:"100%", l:"54%", a:1 },   
    { h:9, s:"100%", l:"64%", a:1 },    
    { h:39, s:"100%", l:"50%", a:1 },   
    { h:51, s:"100%", l:"50%", a:1 },   
    { h:60, s:"100%", l:"80%", a:1 },  
    { h:0, s:"100%", l:"50%", a:1 },    
    { h:0, s:"100%", l:"25%", a:1 },   
    { h:0, s:"0%", l:"27%", a:1 }      
], // Greens
    [
  { h:120, s:"100%", l:"55%", a:1 },  // base bright green
  { h:115, s:"100%", l:"50%", a:1 },  // slightly warmer green
  { h:125, s:"100%", l:"60%", a:1 },  // slightly cooler, lighter
  { h:130, s:"90%",  l:"50%", a:1 },  // a touch desaturated
  { h:110, s:"100%", l:"58%", a:1 },  // bold lime-ish
  { h:135, s:"95%",  l:"55%", a:1 }   // teal-leaning variation
],// Reds
    [
  { h:0,   s:"100%", l:"55%", a:1 },
  { h:5,   s:"100%", l:"50%", a:1 },
  { h:350, s:"95%",  l:"60%", a:1 },
  { h:10,  s:"100%", l:"58%", a:1 },
  { h:355, s:"90%",  l:"52%", a:1 }
], // Blues
    [
  { h:210, s:"100%", l:"55%", a:1 },
  { h:220, s:"100%", l:"50%", a:1 },
  { h:200, s:"95%",  l:"60%", a:1 },
  { h:230, s:"100%", l:"58%", a:1 },
  { h:205, s:"90%",  l:"52%", a:1 }
], // Golds (yellow/orange)
    [
  { h:45,  s:"100%", l:"55%", a:1 },
  { h:50,  s:"100%", l:"50%", a:1 },
  { h:40,  s:"95%",  l:"60%", a:1 },
  { h:35,  s:"100%", l:"58%", a:1 },
  { h:55,  s:"90%",  l:"52%", a:1 }
]];

class Rocket {
    config = {
        launch: {count:1, lifetime:120, maxTrail:12, color:{h:0, s:"0%", l:"100%", a:1}, "colors": colors},
        explosion: {count:48, lifetime:120, spread:360, maxTrail:16, speed:1.2, color:{ h:120, s:"100%", l:"55%", a:1 }, "colors": colors}
    };
    constructor(x, y) {
        this.originalX = x;
        this.originalY = y;
        this.launchTime = mt_rand(2, 7) * 60;
        this.countdown = 0;
        this.reset(x, y);
    }
    reset(x, y) {
        this.config.launch.colors = randomFrom(colors);
        this.launch = new SprayFX(x, y, this.config.launch);
        this.exploded = false;
        this.explosion = null;
        this.countdown = 0;
    }
    initExplosion() {
        const p = this.launch.getParticle(0);
        this.config.explosion.colors = randomFrom(colors);
        this.explosion = new SprayFX(p.x, p.y, this.config.explosion);
        this.exploded = true;
    }
    explode(dt, ctx) {
        this.explosion.updateAndDraw(dt, ctx);
        if ( this.explosion.inActive() )
            this.reset(this.originalX, this.originalY);
    }
    updateAndDraw(dt, ctx) {
        this.countdown++;
        if ( this.countdown < this.launchTime ) return;
        if ( this.launch.active() ) {
            this.launch.updateAndDraw(dt, ctx);
        }
        else {
            if ( this.explosion === null ) {
                this.initExplosion();
            }
            this.explode(dt, ctx);
        }
    }
}
    
class DeltaReport {
    static lastTime = performance.now();
    static frameCount = 0;
    static sum = 0;
    static min = 60;
    static max = 0;
    static elapsedSeconds = 0;
    static report = document.getElementById("fps-report");
    
    static log(timestamp) {
        this.frameCount++;
        const delta = (timestamp - this.lastTime) / 16.67;
        this.sum += delta;
        this.lastTime = timestamp;
        if ( this.frameCount === 120 ) { // every 2 seconds
            this.elapsedSeconds += 2;
            const minutes = Math.floor(this.elapsedSeconds / 60);
            const fps = parseInt(60 / (this.sum / this.frameCount));
            if ( fps < this.min ) this.min = fps; 
            if ( fps > this.max ) this.max = fps; 
            console.log("time", minutes, ":", this.elapsedSeconds % 60, " fps=", fps, " min=", this.min, " max=", this.max);
            //this.report.innerText = fps + " " + this.min + " " + this.max;
            this.frameCount = 0;
            this.sum = 0;
        }
    }
}

class SparkleFX {
  constructor(x, y, count = 12, radius = 30) {
    this.x = x;
    this.y = y;
    this.count = count;
    this.radius = radius;
  }

  updateAndDraw(dt, ctx) {
    for (let i = 0; i < this.count; i++) {
      // random offset above origin
      const angle = Math.PI + Math.random() * Math.PI;
      const r = Math.random() * this.radius;

      const px = this.x + Math.cos(angle) * r;
      const py = this.y + Math.sin(angle) * r;

      ctx.fillStyle = "white";
      ctx.beginPath();
      ctx.arc(px, py, 1, 0, Math.PI * 2);
      ctx.fill();
    }
  }
}

//const spray = new SprayFX(mt_rand(200, 1720), 900, {count:12, canReset:true, speed:1.2, "colors":randomFrom(colors)});
let display = [];
for ( let i = 0; i < 12; i++ ) {
    display.push(new Rocket(mt_rand(200, 1720), 900));
}
for ( let i = 0; i < 6; i++ ) {
    display.push(new SprayFX(mt_rand(200, 1720), 900, {count:12, canReset:true, speed:1.2, "colors":randomFrom(colors), spread:mt_rand(20, 80)}));
}
display.push(new SparkleFX(mt_rand(200, 1720), 900, 12, 20));

//const rocket = new Rocket(960, 900);
const bg = new Image();
bg.src = "night-sky.jpg";
let lastTime = performance.now();
function loop(now) {
    requestAnimationFrame(loop);
    const dt = now - lastTime;
    lastTime = now;
    //ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
    for ( const r of display)
        r.updateAndDraw(dt, ctx);
    //rocket.updateAndDraw(dt, ctx);
    //spray.updateAndDraw(dt, ctx);

    DeltaReport.log(now);
}

loop(lastTime);
</script>
</body>
</html>
