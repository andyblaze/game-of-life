<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dreamflow â€” CPU optimized</title>
<style>
html,body {
    height:100%;
    margin:0;
    background:#050507;
    color:#eaf2ff;
    font-family:system-ui,Segoe UI,Roboto,Arial;
}
canvas {
    display:block;
    width:100%;
    height:100vh
}
</style>
</head>
<body>
<input id="dif" type="hidden"value="26" />
<input id="adv" type="hidden" value="40" />
<input id="dmp" type="hidden" value="8" />
<input id="exc" type="hidden" value="12" />
<input id="fde" type="hidden" value="90" />
<input id="gridW" type="hidden" value="480" />
<input id="gridH" type="hidden" value="270" />

<canvas id="onscreen"></canvas>

<script>
const onscreen = document.getElementById("onscreen");
const onCtx = onscreen.getContext("2d", { alpha: false });

const offscreen = document.createElement("canvas");
const offCtx = offscreen.getContext("2d");


const gridWIn = document.getElementById('gridW');
const gridHIn = document.getElementById('gridH');

const diff = document.getElementById('dif');
const adv = document.getElementById('adv');
const damp = document.getElementById('dmp');
const exc = document.getElementById('exc');
const fade = document.getElementById('fde');



// Simulation parameters (start values)
const config = {  
    W: parseInt(gridWIn.value,10), 
    H: parseInt(gridHIn.value,10),
    diffusion: parseFloat(diff.value)/100,
    advection: parseFloat(adv.value)/100,
    damping: parseFloat(damp.value)/1000,
    excitationRate: parseFloat(exc.value),
    fadeStrength: parseFloat(fade.value)/100,
    onscreenCanvas: onscreen,
    "onCtx": onCtx,
    offscreenCanvas: offscreen,
    "offCtx": offCtx
};
</script>

<script type="text/javascript" src="functions.js"></script>
<script type="text/javascript" src="excitations.js"></script>
<script type="text/javascript" src="dreamflow.js"></script>
<script type="text/javascript" src="shapes.js"></script>
<script type="text/javascript" src="brushes.js"></script>
<script type="text/javascript" src="motions.js"></script>
<script type="text/javascript" src="brush-scheduler.js"></script>
<script type="text/javascript" src="delta-report.js"></script>


<script type="text/javascript">


const dreamFlow = new DreamFlow(config, new RandomExcite(config));

const brushes = [
    new ShapeBrush(6, new Polygon(config, 4), new Spin(0.02)),
    new ShapeBrush(6, new Polygon(config, 3), new Rotate(0.02, 1, -1)),
    new ShapeBrush(5, new Polygon(config, 8), new Pulse()),
    new Brush(7, new PathShape(wavePath, config, 0.05, 200), new Wobble()),
    new Brush(6, new PathShape(spiralPath, config, 3, 200), new Wobble()),
    new LissajousBrush(6, config, 80, 5, 7, 0.002),
    new ShapeBrush(6, new Line(config, 200), new Rotate(0.03)),
    new ShapeBrush(6, new Star(config), new Wobble()), //RotatingMotion(0.03)),
    new RotatingLineBrush(5, config, 250, 0.04),
    new ChaoticDuoBrush(5)
];
const scheduler = new BrushScheduler(brushes, new NullBrush());
dreamFlow.addScheduler(scheduler);

// top-level loop
let lastFrame = performance.now();
function loop(now) {
    if ( ! dreamFlow.running ) return;
    lastFrame = now;
    const dt = Math.max(1, now - lastFrame);
    dreamFlow.update(dt, offCtx, onCtx);

    DeltaReport.log(now);
    requestAnimationFrame(loop);
}

  // init
function init(){
    resizeCanvas();
    requestAnimationFrame(loop);
}
window.addEventListener('resize', resizeCanvas);
init();

</script>
</body>
</html>
